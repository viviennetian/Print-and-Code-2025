<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CARE MART: Unseen Costs</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
      /* --- 1. 全局设置 --- */
      body {
        margin: 0;
        padding: 0;
        font-family: "Helvetica Neue", Arial, sans-serif;
        background-color: #ffffff;
        height: 100vh;
        overflow: hidden;
        position: relative;
      }

      /* --- 2. 海报层 (底层) --- */
      #poster-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #e0e0e0;
        background-image: radial-gradient(#ccc 1px, transparent 1px);
        background-size: 20px 20px;
        z-index: 1;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .center-title {
        font-family: "Gotham";
        font-weight: 900;
        font-size: 80px;
        color: #111;
        text-transform: uppercase;
        z-index: 1000;
        text-align: center;
        pointer-events: none;
      }
      /* 海报里散落的小票样式 */
      .scattered-receipt {
        position: absolute;
        width: 200px;
        background: #fff;
        padding: 15px;
        font-family: "Courier New", monospace;
        font-size: 10px;
        color: #000;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        z-index: 10;
        transition: transform 0.3s;
        clip-path: polygon(
          0% 0%,
          100% 0%,
          100% 100%,
          95% 99%,
          90% 100%,
          85% 99%,
          80% 100%,
          75% 99%,
          70% 100%,
          65% 99%,
          60% 100%,
          55% 99%,
          50% 100%,
          45% 99%,
          40% 100%,
          35% 99%,
          30% 100%,
          25% 99%,
          20% 100%,
          15% 99%,
          10% 100%,
          5% 98%,
          0% 100%
        );
      }
      .scattered-receipt:hover {
        z-index: 999;
        transform: scale(1.1) !important;
      }
      /* 同时修改一下 .poster-controls 让按钮竖着排比较好看 */
      .poster-controls {
        position: absolute;
        bottom: 30px;
        right: 30px;
        z-index: 2000;
        display: flex;
        flex-direction: column; /* 让按钮竖向排列 */
        align-items: flex-end;
      }
      .btn-back {
        padding: 15px 30px;
        background: #111;
        color: #fff;
        border: none;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
      }
      .btn-back:hover {
        background: #333;
      }
      /* 新增这个样式 */
      .btn-export {
        padding: 15px 30px;
        border: 2px solid #000;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
        font-family: "Courier New", monospace;
        text-transform: uppercase;
        background: #fff;
        color: #000;
        margin-bottom: 10px; /* 让它和返回按钮有点间距 */
        display: block; /* 确保它独占一行或排列整齐 */
      }
      .btn-export:hover {
        background: #000;
        color: #fff;
      }

      /* --- 3. 购物层 (顶层) --- */
      #shop-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #ffffff;
        z-index: 5000;
        display: flex;
        transition: transform 0.6s cubic-bezier(0.19, 1, 0.22, 1);
      }
      body.show-poster #shop-layer {
        transform: translateY(-100%);
      }

      /* --- Market Area (双线货架版) --- */
      .market-area {
        flex: 1;
        padding: 40px;
        overflow-y: auto;
        display: grid;
        /* 1. 自适应宽度：最小 200px */
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        /* 2. 关键：左右间距设为 0 (0px)，确保线条连贯 */
        gap: 60px 0px;
        align-content: start;
        background: #f4f4f4; /* 保持浅灰背景 */
      }

      .product-card {
        border: none;
        background: transparent;
        padding: 0;
        cursor: pointer;
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%; /* 占满格子宽度 */
      }

      /* --- Layer 1: 商品图 (宽大) --- */
      .card-layer-product {
        z-index: 3;
        /* 关键改动：宽度设为 100%，让它占满整个网格格子的宽度 */
        width: 100%;
        /* 限制最大高度，防止竖长的图片撑破布局 */
        height: 160px;

        display: flex;
        align-items: flex-end;
        justify-content: center;
        margin-bottom: -5px;
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      .card-layer-product img {
        /* 关键改动：
       让图片宽度最大化，同时保持比例。
       如果图片本身很宽(679px)，它会横向填满格子；
       如果图片很高，它会受限于 height: 100%。
    */
        width: auto;
        max-width: 95%; /* 留一点点边距 */
        height: auto;
        max-height: 100%;
        object-fit: contain;
      }

      /* Layer 2: 货架 (两条黑线) */
      .card-layer-shelf {
        z-index: 5;
        width: 100%; /* 100% 宽度确保左右相连 */
        height: 10px; /* 两条线中间的空隙高度 */
        background: transparent; /* 中间镂空 */

        /* === 核心：用边框画出两条线 === */
        border-top: 12px solid #000; /* 上面的线 */
        border-bottom: 12px solid #000; /* 下面的线 */
      }

      /* --- Layer 3: 价签 (窄小) --- */
      .card-layer-tag {
        z-index: 8;

        /* 关键改动：
       根据你的比例 (679 vs 280 ≈ 2.4倍)，
       既然格子大概 200px-240px 宽，
       那 Tag 的宽度应该设为 90px - 100px 左右比较合适。
    */
        width: 100px;
        height: auto;

        margin-top: -28px;
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        transform-origin: top center;
      }

      .card-layer-tag img {
        width: 100%;
        height: auto;
        display: block;
      }

      /* === 悬停动画 === */
      /* 商品上浮 */
      .product-card:hover .card-layer-product {
        transform: translateY(-12px);
      }
      /* 价签轻微摆动 */
      .product-card:hover .card-layer-tag {
        transform: translateY(2px) rotate(2deg);
      }

      /* --- 随机物品按钮 --- */
      .fab-add {
        position: absolute;
        bottom: 40px;
        left: 15%;
        transform: translateX(-50%);
        background: #ffffff;
        color: #000000;
        border: 1px solid #000;
        padding: 12px 25px;
        border-radius: 0px;
        font-family: "Courier New", Courier, monospace;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 5px 5px 5cap rgba(0, 0, 0, 0.1);
        z-index: 100;
      }

      .fab-add:hover {
        background: #000;
        color: #fff;
      }

      /* 核心改动：将 wallet-area 变成一张长小票 */
      .wallet-area {
        width: 340px;
        background: #f0f0f0;
        /* 移除原来的边框和阴影 */
        border: 0.5px solid #000;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); /* 给整张纸加一个轻微的浮起阴影 */
        display: flex;
        flex-direction: column;
        position: relative;
        /* 统一使用小票字体 */
        font-family: "Courier New", Courier, monospace;
        color: #000;
        margin: 20px; /* 与边缘留点空隙 */
        height: calc(100% - 40px); /* 高度占满 */
        /* 添加顶部和底部的锯齿效果 */
        clip-path: polygon(
          0% 0%,
          100% 0%,
          100% 100%,
          95% 99%,
          90% 100%,
          85% 99%,
          80% 100%,
          75% 99%,
          70% 100%,
          65% 99%,
          60% 100%,
          55% 99%,
          50% 100%,
          45% 99%,
          40% 100%,
          35% 99%,
          30% 100%,
          25% 99%,
          20% 100%,
          15% 99%,
          10% 100%,
          5% 98%,
          0% 100%
        );
      }

      .wallet-header {
        padding: 20px;
        background: transparent; /* 透明背景 */
        border-bottom: 1.5px dashed #000; /* 虚线分割 */
        text-align: center;
      }
      .balance-amount {
        font-size: 36px;
        font-weight: bold;
        margin-top: 5px;
        color: #000;
      }

      .transaction-list {
        flex: 1;
        padding: 10px 20px;
        overflow-y: auto;
        /* 隐藏滚动条但保持可滚动 (兼容性写法) */
        scrollbar-width: none;
        -ms-overflow-style: none;
      }
      .transaction-list::-webkit-scrollbar {
        display: none;
      }

      /* 列表项的小票化改造 */
      .tx-item {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 8px;
        padding-bottom: 8px;
        border-bottom: 1px dotted #000; /* 点状分割线 */
        font-size: 12px;
        animation: slideIn 0.3s ease;
      }
      .tx-info {
        flex: 1;
      }
      .tx-name {
        font-weight: bold;
      }
      .tx-meta {
        font-size: 10px;
        display: block;
        margin-top: 2px;
      }
      /* 价格不再分红绿，统一黑色 */
      .tx-price {
        font-weight: bold;
        margin: 0 10px;
        color: #000;
      }

      .btn-delete {
        color: #000;
        cursor: pointer;
        font-size: 14px;
        padding: 0 5px;
        font-weight: bold;
      }
      .btn-delete:hover {
        color: #ff3333; /* 只有鼠标放上去才显示红色叉号 */
      }

      .wallet-footer {
        padding: 20px;
        background: transparent;
        border-top: 1.5px dashed #000; /* 虚线分割 */
        text-align: center;
      }
      /* 结算按钮小票化 */
      .btn-checkout {
        width: 100%;
        padding: 12px;
        background: #fff;
        color: #000;
        border: 1px solid #000; /* 黑框按钮 */
        font-weight: bold;
        cursor: pointer;
        font-family: "Courier New", monospace;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: all 0.2s;
        box-shadow: 2px 2px 2px rgba(0, 0, 0, 0.1);
      }
      .btn-checkout:hover {
        background: #000;
        color: #fff;
      }
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <div id="poster-layer">
      <div class="center-title">UNSEEN<br />COSTS</div>
      <div id="receipt-container"></div>
      <div class="poster-controls">
        <button class="btn-export" onclick="exportToPDF()">
          Export Poster (PDF)
        </button>
        <button class="btn-back" onclick="continueShopping()">
          + Continue Life (Shop More)
        </button>
      </div>
    </div>

    <div id="shop-layer">
      <div class="market-area" id="shelf">
        <button class="fab-add" onclick="addRandomProduct()">
          + Show Me More Items In the Market
        </button>
      </div>

      <div class="wallet-area">
        <div class="wallet-header">
          <div style="font-size: 12px; font-weight: bold">CARE MART</div>
          <div style="font-size: 10px; margin-bottom: 10px">
            Store #0821 - Live Balance
          </div>
          <div class="balance-amount" id="balance">50.00</div>
          <div style="font-size: 10px">AU (Affective Units)</div>
        </div>
        <div class="transaction-list" id="cart-list">
          <div
            id="empty-msg"
            style="
              text-align: center;
              color: #000;
              margin-top: 50px;
              font-size: 12px;
              font-weight: bold;
            "
          >
            [ RECEIPT EMPTY ]<br />...WAITING FOR INPUT...
          </div>
        </div>
        <div class="wallet-footer">
          <button class="btn-checkout" onclick="checkoutAndGenerate()">
            PRINT & POST
          </button>
        </div>
      </div>
    </div>

    <script>
      // === 数据配置 ===
      const inventory = [
        // ---------- PAGE 1 ROW 1 ----------
        {
          imageSrc: "images/item_highheels.png",
          tagSrc: "images/tag_highheels.png",
          name: "High Heels",
          price: -25.0,
          type: "debit",
          stickerText: "POSTURE DAMAGE ALERT",
        },
        {
          imageSrc: "images/item_plushbunnytoy.png",
          tagSrc: "images/tag_plushbunnytoy.png",
          name: "Plush Bunny Toy",
          price: 18.0,
          type: "credit",
          stickerText: "EMOTIONAL SUPPORT TOKEN",
        },
        {
          imageSrc: "images/item_breakfastsandwich.png",
          tagSrc: "images/tag_breakfastsandwich.png",
          name: "Breakfast Sandwich",
          price: -4.8,
          type: "debit",
          stickerText: "MORNING RUSH DEDUCTION",
        },
        {
          imageSrc: "images/item_instantnoodles.png",
          tagSrc: "images/tag_instantnoodles.png",
          name: "Instant Noodles",
          price: -3.4,
          type: "debit",
          stickerText: "LOW VALUE INPUT",
        },
        {
          imageSrc: "images/item_alcoholminibottle.png",
          tagSrc: "images/tag_alcoholminibottle.png",
          name: "Alcohol Mini Bottle",
          price: -7.0,
          type: "debit",
          stickerText: "TEMPORARY ESCAPE FEE",
        },
        {
          imageSrc: "images/item_soothingfacialmist.png",
          tagSrc: "images/tag_soothingfacialmist.png",
          name: "Soothing Facial Mist",
          price: 8.5,
          type: "credit",
          stickerText: "REFRESHMENT PULSE",
        },

        // ---------- PAGE 1 ROW 2 ----------
        {
          imageSrc: "images/item_spicychipsbag.png",
          tagSrc: "images/tag_spicychipsbag.png",
          name: "Spicy Chips Bag",
          price: -3.9,
          type: "debit",
          stickerText: "DIGESTIVE DISTURBANCE",
        },
        {
          imageSrc: "images/item_smartphonepro.png",
          tagSrc: "images/tag_smartphonepro.png",
          name: "Smartphone Pro",
          price: -240.0,
          type: "debit",
          stickerText: "HIGH DRAIN DEVICE",
        },
        {
          imageSrc: "images/item_heatpatch.png",
          tagSrc: "images/tag_heatpatch.png",
          name: "Heat Patch",
          price: 5.8,
          type: "credit",
          stickerText: "TENSION RELEASE MODULE",
        },
        {
          imageSrc: "images/item_herbalteabox.png",
          tagSrc: "images/tag_herbalteabox.png",
          name: "Herbal Tea Box",
          price: 6.0,
          type: "credit",
          stickerText: "CALMING INPUT",
        },
        {
          imageSrc: "images/item_heavytextbook.png",
          tagSrc: "images/tag_heavytextbook.png",
          name: "Heavy Textbook",
          price: -15.0,
          type: "debit",
          stickerText: "MENTAL LOAD WARNING",
        },

        // ---------- PAGE 1 ROW 3 ----------
        {
          imageSrc: "images/item_laptopcharger.png",
          tagSrc: "images/tag_laptopcharger.png",
          name: "Laptop Charger",
          price: -28.0,
          type: "debit",
          stickerText: "ENERGY EXTRACTION FEE",
        },
        {
          imageSrc: "images/item_portablepowerbank.png",
          tagSrc: "images/tag_portablepowerbank.png",
          name: "Portable Power Bank",
          price: -18.0,
          type: "debit",
          stickerText: "OVERTIME SURCHARGE",
        },
        {
          imageSrc: "images/item_otcsleepaid.png",
          tagSrc: "images/tag_otcsleepaid.png",
          name: "OTC Sleep Aid",
          price: -13.0,
          type: "debit",
          stickerText: "SYNTHETIC REST TOKEN",
        },
        {
          imageSrc: "images/item_softblanket.png",
          tagSrc: "images/tag_softblanket.png",
          name: "Soft Blanket",
          price: 22.0,
          type: "credit",
          stickerText: "RESTORATION UNIT",
        },
        {
          imageSrc: "images/item_mechanicalkeyboard.png",
          tagSrc: "images/tag_mechanicalkeyboard.png",
          name: "Mechanical Keyboard",
          price: -32.0,
          type: "debit",
          stickerText: "WORKLOAD AMPLIFIER",
        },
        {
          imageSrc: "images/item_lavenderpillowspray.png",
          tagSrc: "images/tag_lavenderpillowspray.png",
          name: "Lavender Pillow Spray",
          price: 9.1,
          type: "credit",
          stickerText: "SLEEP ENHANCEMENT FIELD",
        },

        // ---------- PAGE 2 ROW 1 ----------
        {
          imageSrc: "images/item_painrelieftablets.png",
          tagSrc: "images/tag_painrelieftablets.png",
          name: "Pain Relief Tablets",
          price: -14.5,
          type: "debit",
          stickerText: "TEMPORARY FUNCTION RESTORE",
        },
        {
          imageSrc: "images/item_energydrink.png",
          tagSrc: "images/tag_energydrink.png",
          name: "Energy Drink",
          price: -5.2,
          type: "debit",
          stickerText: "SHORT-TERM BOOST PENALTY",
        },
        {
          imageSrc: "images/item_espressoshot.png",
          tagSrc: "images/tag_espressoshot.png",
          name: "Espresso Shot",
          price: -4.6,
          type: "debit",
          stickerText: "ADRENALINE TAX",
        },
        {
          imageSrc: "images/item_coldbrewbottle.png",
          tagSrc: "images/tag_coldbrewbottle.png",
          name: "Cold Brew Bottle",
          price: -5.4,
          type: "debit",
          stickerText: "STIMULATION FEE",
        },
        {
          imageSrc: "images/item_workgloves.png",
          tagSrc: "images/tag_workgloves.png",
          name: "Work Gloves",
          price: -7.8,
          type: "debit",
          stickerText: "LABOR INTENSITY TAG",
        },
        {
          imageSrc: "images/item_earbuds.png",
          tagSrc: "images/tag_earbuds.png",
          name: "Earbuds",
          price: -65.0,
          type: "debit",
          stickerText: "ISOLATED OVERLOAD",
        },
        {
          imageSrc: "images/item_friedchicken.png",
          tagSrc: "images/tag_friedchicken.png",
          name: "Fried Chicken",
          price: -11.8,
          type: "debit",
          stickerText: "HEAVY PROCESSING COST",
        },

        // ---------- PAGE 2 ROW 2 ----------
        {
          imageSrc: "images/item_freshbreadloaf.png",
          tagSrc: "images/tag_freshbreadloaf.png",
          name: "Fresh Bread Loaf",
          price: 4.9,
          type: "credit",
          stickerText: "WARMTH INPUT",
        },
        {
          imageSrc: "images/item_commuterbackpack.png",
          tagSrc: "images/tag_commuterbackpack.png",
          name: "Commuter Backpack",
          price: -12.0,
          type: "debit",
          stickerText: "DAILY BURDEN TAG",
        },
        {
          imageSrc: "images/item_warmsocks.png",
          tagSrc: "images/tag_warmsocks.png",
          name: "Warm Socks",
          price: 7.2,
          type: "credit",
          stickerText: "THERMAL COMFORT BOOST",
        },
        {
          imageSrc: "images/item_vitamingummies.png",
          tagSrc: "images/tag_vitamingummies.png",
          name: "Vitamin Gummies",
          price: 7.4,
          type: "credit",
          stickerText: "BODY MAINTENANCE CREDIT",
        },
        {
          imageSrc: "images/item_yogamat.png",
          tagSrc: "images/tag_yogamat.png",
          name: "Yoga Mat",
          price: 28.0,
          type: "credit",
          stickerText: "REBALANCING MODULE",
        },
        {
          imageSrc: "images/item_sweetpastrybox.png",
          tagSrc: "images/tag_sweetpastrybox.png",
          name: "Sweet Pastry Box",
          price: -6.2,
          type: "debit",
          stickerText: "PLEASURE TAX",
        },

        // ---------- PAGE 2 ROW 3 ----------
        {
          imageSrc: "images/item_cozyslippers.png",
          tagSrc: "images/tag_cozyslippers.png",
          name: "Cozy Slippers",
          price: 16.0,
          type: "credit",
          stickerText: "FOOT COMFORT PRIORITY",
        },
        {
          imageSrc: "images/item_bathsaltjar.png",
          tagSrc: "images/tag_bathsaltjar.png",
          name: "Bath Salt Jar",
          price: 11.0,
          type: "credit",
          stickerText: "MUSCLE RECOVERY PROGRAM",
        },
        {
          imageSrc: "images/item_handcreamtube.png",
          tagSrc: "images/tag_handcreamtube.png",
          name: "Hand Cream Tube",
          price: 6.3,
          type: "credit",
          stickerText: "SOFTNESS MODULE",
        },
        {
          imageSrc: "images/item_anniversarycandle.png",
          tagSrc: "images/tag_anniversarycandle.png",
          name: "Anniversary Candle",
          price: 9.5,
          type: "credit",
          stickerText: "MOOD REALIGNMENT",
        },
        {
          imageSrc: "images/item_freshflowersbouquet.png",
          tagSrc: "images/tag_freshflowersbouquet.png",
          name: "Fresh Flowers Bouquet",
          price: 12.0,
          type: "credit",
          stickerText: "AESTHETIC RECOVERY",
        },
        {
          imageSrc: "images/item_essentialoilsrollon.png",
          tagSrc: "images/tag_essentialoilsrollon.png",
          name: "Essential Oils Roll-On",
          price: 9.2,
          type: "credit",
          stickerText: "AROMA CALIBRATION",
        },
        {
          imageSrc: "images/item_mineralwaterbottle.png",
          tagSrc: "images/tag_mineralwaterbottle.png",
          name: "Mineral Water Bottle",
          price: 1.8,
          type: "credit",
          stickerText: "BASIC SUSTAIN FUNCTION",
        },
      ];

      let currentBalance = 50.0;
      let currentCartItems = [];
      const shelfEl = document.getElementById("shelf");
      const cartEl = document.getElementById("cart-list");
      const balanceEl = document.getElementById("balance");
      const receiptContainer = document.getElementById("receipt-container");

      function renderCard(product) {
        const card = document.createElement("div");
        card.className = "product-card";

        // 占位符逻辑，防止图片缺失
        const safeTagSrc =
          product.tagSrc || "https://placehold.co/150x80/fff/000?text=TAG";

        card.innerHTML = `
        <div class="card-layer-product">
            <img src="${product.imageSrc}" alt="${product.name}" onerror="this.src='https://placehold.co/200x200/eee/999?text=Item'">
        </div>
        
        <div class="card-layer-shelf"></div>
        
        <div class="card-layer-tag">
            <img src="${safeTagSrc}" alt="Price Tag">
        </div>
    `;

        card.onclick = () => addToCart(product);
        shelfEl.appendChild(card);
      }

      function addRandomProduct() {
        const randomItem =
          inventory[Math.floor(Math.random() * inventory.length)];
        renderCard(randomItem);
      }

      function addToCart(product) {
        if (document.getElementById("empty-msg"))
          document.getElementById("empty-msg").remove();
        const item = document.createElement("div");
        item.className = "tx-item";
        // 价格符号
        const priceSign = product.type === "credit" ? "+" : "";
        const time = new Date().toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });

        // 小票风格的列表项HTML
        item.innerHTML = `
                <div class="tx-info">
                    <div class="tx-name">${product.name}</div>
                    <span class="tx-meta">${time} . ${
          product.stickerText
        }</span>
                </div>
                <div class="tx-price">${priceSign}${product.price.toFixed(
          2
        )}</div>
                <div class="btn-delete">X</div>
            `;
        const itemData = {
          name: product.name,
          price: product.price,
          type: product.type,
        };
        currentCartItems.push(itemData);

        item.querySelector(".btn-delete").onclick = function () {
          item.remove();
          updateBalance(-product.price);
          const index = currentCartItems.indexOf(itemData);
          if (index > -1) currentCartItems.splice(index, 1);
          if (cartEl.children.length === 0) {
            cartEl.innerHTML =
              '<div id="empty-msg" style="text-align:center; color:#000; margin-top:50px; font-size:12px; font-weight:bold;">[ RECEIPT EMPTY ]<br>...WAITING FOR INPUT...</div>';
          }
        };
        cartEl.insertBefore(item, cartEl.firstChild);
        updateBalance(product.price);
      }

      // 更新余额 (颜色移除，统一黑色)
      function updateBalance(amount) {
        currentBalance += amount;
        balanceEl.innerText = currentBalance.toFixed(2);
        // balanceEl.style.color = currentBalance < 20 ? '#e74c3c' : '#333'; // 旧逻辑，移除
      }

      function checkoutAndGenerate() {
        if (currentCartItems.length === 0) {
          alert("Ticket empty!");
          return;
        }
        createPosterReceipt(currentCartItems, currentBalance);
        currentCartItems = [];
        cartEl.innerHTML =
          '<div id="empty-msg" style="text-align:center; color:#000; margin-top:50px; font-size:12px; font-weight:bold;">[ RECEIPT EMPTY ]<br>...WAITING FOR INPUT...</div>';
        document.body.classList.add("show-poster");
      }

      function createPosterReceipt(items, finalBalance) {
        const receipt = document.createElement("div");
        receipt.className = "scattered-receipt";

        let itemsHtml = "";
        let totalLoad = 0;

        // 生成商品列表
        items.forEach((item) => {
          itemsHtml += `
            <div style="display:flex; justify-content:space-between; margin-bottom:5px; border-bottom:1px dotted #000;">
                <span>${item.name}</span>
                <span>${item.price.toFixed(2)}</span>
            </div>`;
          totalLoad += item.price;
        });

        const randomId = Math.floor(Math.random() * 9000) + 1000;

        // --- 在这里加入了你要求的声明 ---
        receipt.innerHTML = `
        <div style="text-align:center; border-bottom:2px dashed #000; padding-bottom:5px; margin-bottom:10px;">
            <strong>CARE MART</strong><br>No. ${randomId}
        </div>
        
        <div style="margin-bottom:10px;">${itemsHtml}</div>
        
        <div style="text-align:right; font-weight:bold; border-top:2px dashed #000; padding-top:5px;">
            TOTAL LOAD: ${totalLoad.toFixed(2)} AU <br>
            BALANCE: ${finalBalance.toFixed(2)} AU
        </div>
        
        <div style="text-align:center; font-size:8px; margin-top:15px; color:#000; line-height: 1.5; font-weight: bold;">
            *** DISCLAIMER ***<br>
            ANY PHYSICAL BURDENS PURCHASED<br>
            TODAY ARE NON-REFUNDABLE.<br>
            <br>
            EMOTIONAL FLUCTUATIONS WILL<br>
            AUTOMATICALLY SETTLE WITHIN 24 HOURS.<br>
            <br>
            
        </div>
    `;
        // 随机位置
        const randomTop = Math.random() * 60 + 20;
        const randomLeft = Math.random() * 60 + 20;

        receipt.style.top = randomTop + "%";
        receipt.style.left = randomLeft + "%";
        receipt.style.transform = `translate(-50%, -50%) rotate(${
          Math.random() * 60 - 30
        }deg)`;
        receiptContainer.appendChild(receipt);
      }

      function continueShopping() {
        document.body.classList.remove("show-poster");
      }

      window.onload = function () {
        addRandomProduct();
        addRandomProduct();
      };

      // === 新增：导出 PDF 的核心功能 ===
      // === 最终版：导出竖向 PDF (7.5 x 10.5) ===
      window.exportToPDF = async function () {
        const { jsPDF } = window.jspdf;
        const element = document.getElementById("poster-layer");

        // 1. 设定目标尺寸：竖向 (宽 7.5 x 高 10.5)
        const targetWidthInches = 7.5;
        const targetHeightInches = 10.5;

        // 2. 临时锁定海报层尺寸 (关键步骤：防止变形)
        const originalWidth = element.style.width;
        const originalHeight = element.style.height;
        const originalPos = element.style.position;

        // 强制把网页元素变成竖向比例 (1125px x 1575px)
        // 这样截图出来的形状就天然是竖着的，放进PDF就不会被挤压
        element.style.width = "1125px";
        element.style.height = "1575px";

        try {
          const canvas = await html2canvas(element, {
            scale: 2, // 保持高清
            useCORS: true,
            backgroundColor: "#F0F0F0",
            // 强制截图区域也设为竖向
            width: 1125,
            height: 1575,
            windowWidth: 1125,
            windowHeight: 1575,
            ignoreElements: (node) => {
              return (
                node.classList.contains("center-title") ||
                node.classList.contains("poster-controls")
              );
            },
          });

          const imgData = canvas.toDataURL("image/jpeg", 0.95);

          // 3. 生成 PDF
          // orientation: 'p' 代表 Portrait (竖向)
          const pdf = new jsPDF({
            orientation: "p",
            unit: "in",
            format: [targetWidthInches, targetHeightInches],
          });

          // 4. 填入图片
          pdf.addImage(
            imgData,
            "JPEG",
            0,
            0,
            targetWidthInches,
            targetHeightInches
          );
          pdf.save("CareMart_Poster_Portrait.pdf");
        } catch (err) {
          console.error("Export failed:", err);
          alert("导出出错，请重试");
        } finally {
          // 5. 恢复原来的样式
          element.style.width = originalWidth;
          element.style.height = originalHeight;
          element.style.position = originalPos;
        }
      };
    </script>
  </body>
</html>
